<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Occasion Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .slide-in { animation: slide-in 0.5s forwards; }
        @keyframes slide-in {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .carousel-item { display: none; }
        .carousel-item.active { display: block; }
        .dots-container .dot {
            height: 8px; width: 8px; margin: 0 4px; background-color: #bbb; border-radius: 50%;
            display: inline-block; transition: background-color 0.3s ease;
        }
        .dots-container .dot.active { background-color: #4a5568; }
        .skeleton-loader {
            background-color: #e2e8f0;
            border-radius: 0.25rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">AI Occasion Checker</h1>
            <p class="text-gray-600 mt-2">Plak de link van een autoadvertentie en krijg een complete AI-analyse.</p>
        </header>

        <main>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input id="urlInput" type="text" placeholder="Plak hier de advertentie URL of het kenteken..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <button id="analyzeBtn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105">
                        <i class="fas fa-search mr-2"></i>Analyseer
                    </button>
                </div>
            </div>

            <div id="loading" class="mt-8 hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-center mb-4">
                        <i class="fas fa-spinner fa-spin text-3xl text-blue-600"></i>
                        <h2 class="text-2xl font-semibold ml-4">Analyse wordt uitgevoerd...</h2>
                    </div>
                    <p class="text-center text-gray-600">De AI bezoekt de link, verzamelt data en stelt een compleet rapport op. Dit kan even duren.</p>
                    <div class="mt-6 space-y-4">
                        <div class="h-8 w-3/4 mx-auto skeleton-loader"></div>
                        <div class="h-4 w-1/2 mx-auto skeleton-loader"></div>
                        <div class="h-4 w-5/6 mx-auto skeleton-loader"></div>
                    </div>
                </div>
            </div>

            <div id="error" class="mt-8 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative hidden" role="alert">
                <strong class="font-bold">Fout: </strong>
                <span id="errorMessage" class="block sm:inline"></span>
            </div>
            
            <div id="results" class="mt-8 space-y-6 hidden">
                <!-- Resultaten worden hier dynamisch ingevoegd -->
            </div>
        </main>
    </div>

    <script>
        const urlInput = document.getElementById('urlInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const errorMessageSpan = document.getElementById('errorMessage');
        const resultsDiv = document.getElementById('results');

        analyzeBtn.addEventListener('click', async () => {
            const input = urlInput.value.trim();
            if (!input) {
                showError('Voer een URL of kenteken in.');
                return;
            }

            hideError();
            resultsDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const data = await fetchAnalysis(input);
                displayResults(data);
            } catch (err) {
                showError(err.message);
            } finally {
                loadingDiv.classList.add('hidden');
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // *** HIER IS DE BELANGRIJKE CORRECTIE ***
        async function fetchAnalysis(input) {
            const response = await fetch(`/api/analyzer?url=${encodeURIComponent(input)}`);
            
            // Stap 1: Controleer EERST of de server een foutstatus (bv. 500) geeft.
            if (!response.ok) {
                // Als er een fout is, probeer de foutmelding als tekst te lezen.
                const errorText = await response.text();
                // Probeer er JSON van te maken, maar als dat niet lukt, gebruik de ruwe tekst.
                try {
                    const errorJson = JSON.parse(errorText);
                    throw new Error(errorJson.error || 'Onbekende serverfout.');
                } catch (e) {
                    throw new Error(errorText || 'Onbekende serverfout.');
                }
            }
            
            // Stap 2: Alleen als de status OK is, proberen we de response als JSON te lezen.
            const data = await response.json();
            
            // Extra controle voor het geval de AI zelf een fout rapporteert in de data
            if (data.error) {
                 throw new Error(data.error);
            }

            return data;
        }

        function displayResults(data) {
            resultsDiv.innerHTML = `
                <div class="slide-in bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">üìã Advertentie Titel</h2>
                    <p>${data.title || 'Niet gevonden'}</p>
                </div>

                <div class="slide-in bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">üñºÔ∏è Foto's</h2>
                    ${generateCarousel(data.photos)}
                </div>

                <div class="slide-in bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">üí∞ Vraagprijs & Marktwaarde</h2>
                    <p class="text-3xl font-bold">‚Ç¨ ${data.price ? data.price.toLocaleString('nl-NL') : 'Niet gevonden'}</p>
                    <!-- Visuele weergave van marktwaarde kan hier komen -->
                </div>

                <div class="slide-in bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">üîß Specificaties</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        ${Object.entries(data.specs || {}).map(([key, value]) => `<div><strong class="capitalize">${key.replace(/_/g, ' ')}:</strong> ${value}</div>`).join('')}
                    </div>
                </div>

                <div class="slide-in bg-white p-6 rounded-xl shadow-lg grid md:grid-cols-2 gap-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-4">üëç Pluspunten</h2>
                        <ul class="list-disc list-inside space-y-2 text-green-700">${(data.pluspunten || []).map(p => `<li>${p}</li>`).join('')}</ul>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4">üëé Minpunten</h2>
                        <ul class="list-disc list-inside space-y-2 text-red-700">${(data.minpunten || []).map(p => `<li>${p}</li>`).join('')}</ul>
                    </div>
                </div>

                <div class="slide-in bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">ü§ù Onderhandelingsadvies</h2>
                    <div class="space-y-2">${(data.onderhandelingsadvies || []).map(p => `<p>${p}</p>`).join('')}</div>
                </div>
                
                <div class="slide-in bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">üèÅ Eindconclusie & Score</h2>
                    <div class="flex items-center">
                        <div class="text-5xl font-bold text-blue-600">${data.score ? data.score.toFixed(1) : '?'}</div>
                        <div class="ml-4">
                             <p>${data.eindconclusie || 'Geen conclusie beschikbaar.'}</p>
                        </div>
                    </div>
                </div>
            `;
            resultsDiv.classList.remove('hidden');
            initializeCarousel();
        }

        function generateCarousel(photos) {
            if (!photos || photos.length === 0) return '<p>Geen foto\'s gevonden.</p>';
            const items = photos.map((src, index) => `
                <div class="carousel-item ${index === 0 ? 'active' : ''}">
                    <img src="${src}" alt="Occasion foto ${index + 1}" class="w-full h-64 md:h-80 object-cover rounded-lg">
                </div>
            `).join('');
            const dots = photos.map((_, index) => `<span class="dot ${index === 0 ? 'active' : ''}" data-slide-to="${index}"></span>`).join('');
            
            return `
                <div class="relative">
                    ${items}
                    <button class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-white bg-opacity-50 rounded-full p-2 carousel-prev"><i class="fas fa-chevron-left"></i></button>
                    <button class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-white bg-opacity-50 rounded-full p-2 carousel-next"><i class="fas fa-chevron-right"></i></button>
                    <div class="dots-container absolute bottom-2 left-1/2 transform -translate-x-1/2">
                        ${dots}
                    </div>
                </div>
            `;
        }

        function initializeCarousel() {
            const carousel = resultsDiv.querySelector('.relative');
            if (!carousel) return;

            const items = carousel.querySelectorAll('.carousel-item');
            const dots = carousel.querySelectorAll('.dot');
            let currentIndex = 0;

            function showSlide(index) {
                items.forEach((item, i) => item.classList.toggle('active', i === index));
                dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
                currentIndex = index;
            }

            carousel.querySelector('.carousel-next').addEventListener('click', () => {
                showSlide((currentIndex + 1) % items.length);
            });
            carousel.querySelector('.carousel-prev').addEventListener('click', () => {
                showSlide((currentIndex - 1 + items.length) % items.length);
            });
            dots.forEach(dot => {
                dot.addEventListener('click', () => showSlide(parseInt(dot.dataset.slideTo)));
            });
        }

        function showError(message) {
            errorMessageSpan.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            errorDiv.classList.add('hidden');
        }
    </script>
</body>
</html>

